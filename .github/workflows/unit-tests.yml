name: BHoM Unit Tests & Coverage (with Bootstrap)

on:
  workflow_call:

jobs:
  bootstrap:
    name: Clone & Build Required BHoM Repos
    runs-on: windows-latest
    permissions:
      contents: read   # for this repo; other repos are accessed via the PAT in 'token'

    steps:
      - name: Checkout Main Repo (this repo)
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      # ---------------------------------------
      # PREPARE ROOT DIRECTORY
      # ---------------------------------------
      - name: Set ProgramData to isolated CI path
        shell: pwsh
        run: |
          echo "ProgramData=C:\bhom" | Out-File -FilePath $env:GITHUB_ENV -Append
          New-Item -ItemType Directory -Force -Path "C:\bhom" | Out-Null

      # ---------------------------
      # CLONE THE CORE BHoM REPOS (PRIVATE; USE PAT SECRET)
      # ---------------------------
      - name: Checkout BHoM
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/BHoM
          path: C:\bhom\BHoM
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      - name: Checkout BHoM_Engine
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/BHoM_Engine
          path: C:\bhom\BHoM_Engine
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      - name: Checkout BHoM_Adapter
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/BHoM_Adapter
          path: C:\bhom\BHoM_Adapter
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      - name: Checkout Test_ToolKit
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/Test_ToolKit
          path: C:\bhom\Test_ToolKit
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      # ---------------------------------------
      # CREATE ASSEMBLIES FOLDER (AFTER CLONE)
      # ---------------------------------------
      - name: Create Assemblies Folder
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path "C:\bhom\BHoM\Assemblies" | Out-Null

      # ---------------------------
      # BUILD IN THE REQUIRED ORDER
      # ---------------------------
      - name: Build BHoM
        shell: pwsh
        run: dotnet build C:\bhom\BHoM\BHoM.sln -c Release

      - name: Build BHoM_Engine
        shell: pwsh
        run: dotnet build C:\bhom\BHoM_Engine\BHoM_Engine.sln -c Release

      - name: Build BHoM_Adapter
        shell: pwsh
        run: dotnet build C:\bhom\BHoM_Adapter\BHoM_Adapter.sln -c Release

      - name: Build Test_ToolKit
        shell: pwsh
        run: dotnet build C:\bhom\Test_ToolKit\Test_Toolkit.sln -c Release

      # ---------------------------------------
      # GATHER ALL DLLs INTO A SINGLE FOLDER
      # ---------------------------------------
      - name: Gather Assemblies Into C:\bhom\BHoM\Assemblies
        shell: pwsh
        run: |
          Copy-Item -Recurse -Force C:\bhom\BHoM\**\bin\Release\**\*.dll        C:\bhom\BHoM\Assemblies
          Copy-Item -Recurse -Force C:\bhom\BHoM_Engine\**\bin\Release\**\*.dll C:\bhom\BHoM\Assemblies
          Copy-Item -Recurse -Force C:\bhom\BHoM_Adapter\**\bin\Release\**\*.dll C:\bhom\BHoM\Assemblies
          Copy-Item -Recurse -Force C:\bhom\Test_ToolKit\**\bin\Release\**\*.dll C:\bhom\BHoM\Assemblies

  tests:
    name: Run Unit Tests
    needs: bootstrap
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Run All Test Projects
        shell: pwsh
        working-directory: .ci/unit-tests
        run: |
          Get-ChildItem -Recurse -Filter *Tests.csproj |
            ForEach-Object {
              dotnet test $_.FullName -c Test --logger trx
            }

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: bhom-test-results
          path: .ci/unit-tests/**/TestResults/*.trx

  coverage:
    name: Generate Code Coverage
    needs: tests
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Install ReportGenerator
        shell: pwsh
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Run Tests With Coverage
        shell: pwsh
        working-directory: .ci/unit-tests
        run: |
          $results = "$PWD\_coverage"
          New-Item -ItemType Directory -Force -Path $results | Out-Null

          Get-ChildItem -Recurse -Filter *Tests.csproj |
            ForEach-Object {
              dotnet test $_.FullName -c Test `
                --collect:"XPlat Code Coverage" `
                --results-directory $results
            }

      - name: Create Coverage Report
        shell: pwsh
        working-directory: .ci/unit-tests
        run: |
          reportgenerator `
            -reports:"_coverage/**/coverage.cobertura.xml" `
            -targetdir:"coverage-report" `
            -reporttypes:Html

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: .ci/unit-tests/coverage-report