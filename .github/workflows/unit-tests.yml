name: BHoM Unit Tests & Coverage (with Bootstrap)

on:
  workflow_call:
    secrets:
      SANDBOX_READ_TOKEN:
        required: true
        description: "Fine-grained PAT with Contents: Read-only for sandbox repos (SSO authorized if enforced)."

jobs:
  bootstrap:
    name: Clone & Build Required BHoM Repos
    runs-on: windows-latest
    permissions:
      contents: read
    defaults:
      run:
        shell: pwsh
    env:
      # Root for all checkouts & artifacts INSIDE the workspace (no C:\ paths)
      BHOM_ROOT: ${{ github.workspace }}\bhom
      ASSEMBLIES_DIR: ${{ github.workspace }}\bhom\BHoM\Assemblies

    steps:
      - name: Checkout Main Repo (this repo)
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Prepare folders
        run: New-Item -ItemType Directory -Force -Path "$env:BHOM_ROOT" | Out-Null

      - name: Set ProgramData to isolated CI path
        run: |
          # Make tools that look in %ProgramData% resolve to our workspace-local root
          "ProgramData=$env:BHOM_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

      # ---------------------------
      # CLONE THE CORE BHoM REPOS (PRIVATE; USE PAT SECRET FROM CALLER)
      # ---------------------------
      - name: Checkout BHoM
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/BHoM
          path: bhom/BHoM
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      - name: Checkout BHoM_Engine
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/BHoM_Engine
          path: bhom/BHoM_Engine
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      - name: Checkout BHoM_Adapter
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/BHoM_Adapter
          path: bhom/BHoM_Adapter
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      - name: Checkout Test_ToolKit
        uses: actions/checkout@v4
        with:
          repository: BuroHappoldEngineeringSandbox/Test_ToolKit
          path: bhom/Test_ToolKit
          token: ${{ secrets.SANDBOX_READ_TOKEN }}

      # ---------------------------------------
      # CREATE ASSEMBLIES FOLDER (AFTER CLONE)
      # ---------------------------------------
      - name: Create Assemblies Folder
        run: New-Item -ItemType Directory -Force -Path "$env:ASSEMBLIES_DIR" | Out-Null

      # ---------------------------
      # BUILD IN THE REQUIRED ORDER
      # ---------------------------
      - name: Build BHoM
        run: dotnet build "$env:BHOM_ROOT\BHoM\BHoM.sln" -c Release

      - name: Build BHoM_Engine
        run: dotnet build "$env:BHOM_ROOT\BHoM_Engine\BHoM_Engine.sln" -c Release

      - name: Build BHoM_Adapter
        run: dotnet build "$env:BHOM_ROOT\BHoM_Adapter\BHoM_Adapter.sln" -c Release

      - name: Build Test_ToolKit
        run: dotnet build "$env:BHOM_ROOT\Test_ToolKit\Test_Toolkit.sln" -c Release

      # ---------------------------------------
      # GATHER ALL DLLs INTO A SINGLE FOLDER
      # ---------------------------------------
      - name: Gather Assemblies Into ${{ env.ASSEMBLIES_DIR }}
        run: |
          Copy-Item -Recurse -Force "$env:BHOM_ROOT\BHoM\**\bin\Release\**\*.dll"        "$env:ASSEMBLIES_DIR"
          Copy-Item -Recurse -Force "$env:BHOM_ROOT\BHoM_Engine\**\bin\Release\**\*.dll" "$env:ASSEMBLIES_DIR"
          Copy-Item -Recurse -Force "$env:BHOM_ROOT\BHoM_Adapter\**\bin\Release\**\*.dll" "$env:ASSEMBLIES_DIR"
          Copy-Item -Recurse -Force "$env:BHOM_ROOT\Test_ToolKit\**\bin\Release\**\*.dll" "$env:ASSEMBLIES_DIR"

  tests:
    name: Run Unit Tests
    needs: bootstrap
    runs-on: windows-latest
    permissions:
      contents: read
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Run All Test Projects
        working-directory: .ci/unit-tests
        run: |
          Get-ChildItem -Recurse -Filter *Tests.csproj |
            ForEach-Object {
              dotnet test $_.FullName -c Test --logger trx
            }

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: bhom-test-results
          path: .ci/unit-tests/**/TestResults/*.trx

  coverage:
    name: Generate Code Coverage
    needs: tests
    runs-on: windows-latest
    permissions:
      contents: read
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Run Tests With Coverage
        working-directory: .ci/unit-tests
        run: |
          $results = "$PWD\_coverage"
          New-Item -ItemType Directory -Force -Path $results | Out-Null

          Get-ChildItem -Recurse -Filter *Tests.csproj |
            ForEach-Object {
              dotnet test $_.FullName -c Test `
                --collect:"XPlat Code Coverage" `
                --results-directory $results
            }

      - name: Create Coverage Report
        working-directory: .ci/unit-tests
        run: |
          reportgenerator `
            -reports:"_coverage/**/coverage.cobertura.xml" `
            -targetdir:"coverage-report" `
            -reporttypes:Html

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: .ci/unit-tests/coverage-report