name: .NET Unit Tests & Coverage

on:
  workflow_call:
    inputs:
      dotnet_version:
        description: ".NET SDK version to use (Default: 8.x)"
        required: false
        type: string
        default: "8.x"
      configuration:
        description: "Build configuration (Default: Release)"
        required: false
        type: string
        default: "Release"
      test_solution:
        description: "Path to the test solution file"
        required: false
        type: string
        default: ".ci/tests/UnitTests/UnitTests.sln"
      dependencies:
        description: >
          Ordered, comma-separated list of public repos to clone & build.
          Supports same-org shorthand "Repo@ref" and cross-org "Owner/Repo@ref".
          Example: "RepoA@main, RepoB, OtherOrg/RepoC@v1.2.3"
        required: false
        type: string
        default: ""

permissions:
  contents: read
  pull-requests: write

jobs:

  build_dependencies:
    name: Build Dependencies
    runs-on: windows-latest
    if: inputs.dependencies != ''
    steps:
      - uses: BuroHappoldEngineeringSandbox/ci-templates/.github/actions/clone-deps
        with:
          dependencies: ${{ inputs.dependencies }}
          configuration: ${{ inputs.configuration }}
          default_org: ${{ github.repository_owner }}

  build_and_test:
    name: Build & Test
    runs-on: windows-latest
    needs: build_dependencies
    if: always()
    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: BuroHappoldEngineeringSandbox/ci-templates/.github/actions/stage-assemblies

      - uses: BuroHappoldEngineeringSandbox/ci-templates/.github/actions/dotnet-test
        with:
          solution: ${{ inputs.test_solution }}
          configuration: ${{ inputs.configuration }}
          dotnet_version: ${{ inputs.dotnet_version }}

  publish_test_results:
    name: Publish Test Results
    runs-on: ubuntu-latest
    needs: build_and_test
    if: always()
    permissions:
      checks: write
      pull-requests: write
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - uses: EnricoMi/publish-unit-test-result-action@v2.16.1
        with:
          trx_files: "test-results/**/*.trx"
