name: Publish Alpha Packages (Reusable)

on:
  workflow_call:

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    
    env:
      MILESTONE: "2.1"  # Hardcoded - update when milestone changes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: BHoM/.github
          path: .github-central
          sparse-checkout: scripts/
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
          source-url: https://nuget.pkg.github.com/BHoM/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # - name: Make scripts executable
      #   run: chmod +x .github-central/scripts/*.sh
      
      - name: Get commit SHA
        id: commit
        run: |
          SHA=$(git rev-parse --short=7 HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "📌 Commit: $SHA"
      
      - name: Find all projects
        id: projects
        run: |
          find . -name "*.csproj" \
            -not -path "*/bin/*" \
            -not -path "*/obj/*" \
            -not -path "*/.git/*" \
            > all_projects.txt
          
          COUNT=$(wc -l < all_projects.txt)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "📦 Found $COUNT project(s)"
      
      - name: Initialize summary
        run: |
          echo "## 📦 Alpha Package Publishing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Milestone:** \`$MILESTONE\` | **Commit:** \`${{ steps.commit.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
      
      - name: Build and publish all packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
          REPO_URL: https://github.com/${{ github.repository }}
        run: |
          SUCCESS=0
          FAILED=0
          
          while IFS= read -r PROJECT_PATH; do
            PKG_NAME=$(basename "$PROJECT_PATH" .csproj)
            
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "📦 $PKG_NAME"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Get next version
            VERSION=$(.github-central/scripts/get-next-version.sh \
              "$PKG_NAME" \
              "$MILESTONE" \
              "$COMMIT_SHA")
            
            if [ $? -ne 0 ]; then
              echo "❌ Failed to determine version"
              echo "| $PKG_NAME | - | ❌ Version error |" >> $GITHUB_STEP_SUMMARY
              FAILED=$((FAILED + 1))
              continue
            fi
            
            # Build and publish
            if .github-central/scripts/build-and-publish.sh \
              "$PROJECT_PATH" \
              "$PKG_NAME" \
              "$VERSION" \
              "$REPO_URL"; then
              echo "✅ Published"
              echo "| $PKG_NAME | \`$VERSION\` | ✅ Published |" >> $GITHUB_STEP_SUMMARY
              SUCCESS=$((SUCCESS + 1))
            else
              echo "❌ Failed"
              echo "| $PKG_NAME | \`$VERSION\` | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
              FAILED=$((FAILED + 1))
            fi
            
          done < all_projects.txt
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** ✅ $SUCCESS published | ❌ $FAILED failed" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 Summary: $SUCCESS published, $FAILED failed"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          [ $FAILED -gt 0 ] && exit 1 || exit 0
