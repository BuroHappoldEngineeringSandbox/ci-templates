name: Build Dependencies

on:
  workflow_call:
    inputs:
      configuration:
        type: string
        default: "Release"
      dependencies:
        type: string
        default: ""

    secrets:
      SANDBOX_READ_TOKEN:
        required: false
      ORG_READ_TOKEN:
        required: false

permissions:
  contents: read

jobs:
  build_dependencies:
    name: Build Dependencies
    runs-on: windows-latest

    env:
      DEFAULT_ORG: ${{ github.repository_owner }}
      TOKEN: ${{ secrets.SANDBOX_READ_TOKEN }}
      CONFIG: ${{ inputs.configuration }}

    outputs:
      artifact-name: deps-assemblies

    steps:
      - name: Setup Git Authentication
        shell: pwsh
        run: |
          if ($env:TOKEN) {
            git config --global url."https://x-access-token:$env:TOKEN@github.com/".insteadOf "https://github.com/"
          }

      - name: Clone Repositories
        shell: pwsh
        env:
          DEPENDENCIES: ${{ inputs.dependencies }}
          TOKEN: ${{ secrets.ORG_READ_TOKEN || github.token }}
        run: |
          $ErrorActionPreference = "Stop"
          New-Item deps -ItemType Directory -Force | Out-Null

          if ($env:TOKEN) {
            git config --global url."https://x-access-token:$env:TOKEN@github.com/".insteadOf "https://github.com/"
          }

          $depsList = @()
          foreach ($entry in @($env:DEPENDENCIES.Split(","))) {
            $t = $entry.Trim()
            if ($t) { $depsList += $t }
          }

          foreach ($d in $depsList) {
            $spec = $d; $ref = ""
            if ($d -match "@") {
              $parts = $d.Split("@",2)
              $spec  = $parts[0].Trim()
              $ref   = $parts[1].Trim()
            }

            if ($spec.Contains("/")) {
              $owner, $repo = $spec.Split("/")
            } else {
              $owner = $env:DEFAULT_ORG; $repo = $spec
            }

            $folder = "$owner`_$repo"
            $url    = "https://github.com/$owner/$repo.git"
            $path   = "deps/$folder"

            git ls-remote $url *> $null
            git clone --depth 1 $url $path

            if ($ref) {
              Push-Location $path
              git fetch --all --tags --prune
              git checkout $ref
              Pop-Location
            }
          }

      - name: Build Solutions
        shell: pwsh
        run: |
          $repos = Get-ChildItem deps -Directory
          foreach ($repoDir in $repos) {
            $sln = Get-ChildItem $repoDir.FullName -Recurse -Filter *.sln | Select-Object -First 1
            if ($sln) {
              dotnet restore $sln.FullName
              dotnet build $sln.FullName --configuration $env:CONFIG
            }
          }

      - name: Collect DLLs
        shell: pwsh
        run: |
          New-Item deps-assemblies -ItemType Directory -Force | Out-Null

          Get-ChildItem deps -Recurse -Include *.dll |
            Where-Object { $_.FullName -match "\\bin\\(Release|Debug)\\" } |
            Copy-Item -Destination deps-assemblies -Force

      - name: Upload Assemblies
        uses: actions/upload-artifact@v4
        with:
          name: deps-assemblies
          path: deps-assemblies/**
          if-no-files-found: warn